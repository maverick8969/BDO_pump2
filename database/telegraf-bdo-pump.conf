# =============================================================================
# TELEGRAF CONFIGURATION FOR BDO PNEUMATIC PUMP
# MQTT â†’ TimescaleDB Integration
# =============================================================================

# Global Agent Configuration
[agent]
  interval = "5s"
  round_interval = true
  metric_batch_size = 1000
  metric_buffer_limit = 10000
  collection_jitter = "0s"
  flush_interval = "5s"
  flush_jitter = "0s"
  precision = ""
  hostname = ""
  omit_hostname = false

# =============================================================================
# GLOBAL TAGS
# =============================================================================

[global_tags]
  facility = "main_factory"
  system = "bdo_pump"

# =============================================================================
# MQTT INPUTS - BDO PNEUMATIC PUMP
# =============================================================================

# -----------------------------------------------------------------------------
# Fill Completion Events
# -----------------------------------------------------------------------------
[[inputs.mqtt_consumer]]
  servers = ["tcp://mosquitto:1883"]
  topics = ["factory/pump/fills"]

  ## QoS (0, 1, or 2)
  qos = 1

  ## Connection timeout
  connection_timeout = "30s"

  ## Authentication (uncomment if needed)
  # username = "telegraf"
  # password = "your_mqtt_password"

  ## Data format
  data_format = "json"
  json_time_key = "timestamp"
  json_time_format = "unix"

  ## Name override (maps to table name)
  name_override = "pump_fills"

  ## Tag keys (these become indexed columns)
  tag_keys = ["device_id", "completion_status"]

# -----------------------------------------------------------------------------
# System Events
# -----------------------------------------------------------------------------
[[inputs.mqtt_consumer]]
  servers = ["tcp://mosquitto:1883"]
  topics = ["factory/pump/events"]

  qos = 1
  connection_timeout = "30s"

  data_format = "json"
  json_time_key = "timestamp"
  json_time_format = "unix"

  name_override = "pump_events"

  tag_keys = ["device_id", "event"]

# -----------------------------------------------------------------------------
# Real-Time Status Updates
# -----------------------------------------------------------------------------
[[inputs.mqtt_consumer]]
  servers = ["tcp://mosquitto:1883"]
  topics = ["factory/pump/status"]

  qos = 0
  connection_timeout = "30s"

  data_format = "json"
  json_time_key = "timestamp"
  json_time_format = "unix"

  name_override = "pump_status"

  tag_keys = ["device_id", "state", "active_zone"]

# =============================================================================
# OUTPUT TO TIMESCALEDB (PostgreSQL)
# =============================================================================

[[outputs.postgresql]]
  ## Connection string
  ## Format: "host=... port=... user=... password=... dbname=... sslmode=..."
  connection = "host=timescaledb port=5432 user=telegraf password=your_secure_password dbname=factory_metrics sslmode=disable"

  ## Create tables automatically if they don't exist
  ## Note: For hypertables, create tables manually first
  create_templates = []

  ## Timeout for writes
  timeout = "5s"

  ## Table mapping
  tables = [
    {
      measurement = "pump_fills",
      table = "pump_fills",
      ## Tags become TEXT columns (indexed)
      tags = ["device_id", "completion_status"],
      ## Fields become data columns
      fields = [
        "target_lbs",
        "actual_lbs",
        "error_lbs",
        "fill_time_ms",
        "fill_number",
        "pressure_avg_pct",
        "zone_transitions"
      ],
      timestamp_column = "time"
    },
    {
      measurement = "pump_events",
      table = "pump_events",
      tags = ["device_id", "event"],
      fields = ["details"],
      timestamp_column = "time"
    },
    {
      measurement = "pump_status",
      table = "pump_status",
      tags = ["device_id", "state", "active_zone"],
      fields = [
        "current_weight_lbs",
        "target_weight_lbs",
        "progress_pct",
        "current_pressure_pct",
        "fill_elapsed_ms",
        "fills_today",
        "total_lbs_today",
        "uptime_seconds"
      ],
      timestamp_column = "time"
    }
  ]

  ## Tag and field templates
  tag_template = "{{.tag}} TEXT"
  field_template = "{{.field}} DOUBLE PRECISION"

# =============================================================================
# OPTIONAL: OUTPUT TO FILE (for debugging)
# =============================================================================
# Uncomment to write data to file for debugging

# [[outputs.file]]
#   files = ["/tmp/telegraf-bdo-pump-debug.out"]
#   data_format = "json"
#   json_timestamp_units = "1s"

# =============================================================================
# OPTIONAL: INTERNAL MONITORING
# =============================================================================

# Monitor Telegraf itself
[[inputs.internal]]
  collect_memstats = true

# =============================================================================
# USAGE NOTES
# =============================================================================

# 1. Update the PostgreSQL connection string with your secure password
# 2. Ensure mosquitto MQTT broker is accessible at the specified server
# 3. Run init-bdo-pump.sql to create tables before starting Telegraf
# 4. Test configuration: telegraf --config telegraf-bdo-pump.conf --test
# 5. Start Telegraf: telegraf --config telegraf-bdo-pump.conf
# 6. Monitor logs: journalctl -u telegraf -f (if systemd service)

# =============================================================================
# DOCKER COMPOSE INTEGRATION
# =============================================================================

# If running in Docker, mount this file to:
#   /etc/telegraf/telegraf.d/bdo-pump.conf
#
# Or update main telegraf.conf to include:
#   [[inputs.execd]]
#     command = ["/etc/telegraf/telegraf.d/bdo-pump.conf"]

# =============================================================================
# GRAFANA DASHBOARD QUERIES
# =============================================================================

# Example queries for Grafana dashboards:
#
# Total Fills Today:
#   SELECT COUNT(*) FROM pump_fills
#   WHERE time >= CURRENT_DATE AND completion_status = 'success'
#
# Total Pounds Dispensed Today:
#   SELECT SUM(actual_lbs) FROM pump_fills
#   WHERE time >= CURRENT_DATE AND completion_status = 'success'
#
# Fill Accuracy Trend (last 24h):
#   SELECT time_bucket('1 hour', time) AS time, AVG(error_lbs) as avg_error
#   FROM pump_fills
#   WHERE time >= NOW() - INTERVAL '24 hours' AND completion_status = 'success'
#   GROUP BY time_bucket('1 hour', time) ORDER BY time
#
# Current System Status:
#   SELECT * FROM latest_pump_status
#
# Hourly Fill Rate:
#   SELECT bucket, fill_count FROM pump_fills_hourly
#   WHERE bucket >= NOW() - INTERVAL '7 days' ORDER BY bucket
