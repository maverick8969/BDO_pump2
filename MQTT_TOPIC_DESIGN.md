# BDO Pneumatic Pump - MQTT Topic Design
## Integration with Existing Factory Infrastructure

**Date:** November 6, 2025
**System:** BDO Pneumatic Pump Controller (ESP32-based)
**Integration:** MQTT â†’ Telegraf â†’ TimescaleDB â†’ Grafana

---

## Overview

This document defines the MQTT topic structure for the BDO Pneumatic Pump Controller, designed to integrate seamlessly with the existing factory monitoring infrastructure.

### Design Principles

âœ… **Consistency:** Follow existing `factory/*` topic hierarchy
âœ… **Compatibility:** JSON payloads parseable by existing Telegraf config
âœ… **Completeness:** Track fills, total lbs, accuracy, and safety events
âœ… **Extensibility:** Support multiple pump controllers (device_id)

---

## MQTT Topics

### 1. Fill Completion Events

**Topic:** `factory/pump/fills`

**Published:** After each fill operation completes (success or failure)

**Payload:**
```json
{
  "device_id": "bdo_pump_01",
  "target_lbs": 200.0,
  "actual_lbs": 200.2,
  "error_lbs": 0.2,
  "fill_time_ms": 178450,
  "fill_number": 1523,
  "pressure_avg_pct": 45.3,
  "zone_transitions": 4,
  "completion_status": "success",
  "timestamp": 1699294832
}
```

**Fields:**
- `device_id` (string): Unique identifier for this pump controller
- `target_lbs` (float): Target fill weight in pounds
- `actual_lbs` (float): Actual weight dispensed in pounds
- `error_lbs` (float): Error (actual - target) in pounds
- `fill_time_ms` (int): Total fill duration in milliseconds
- `fill_number` (int): Sequential fill counter (lifetime)
- `pressure_avg_pct` (float): Average pressure during fill (0-100%)
- `zone_transitions` (int): Number of zone changes (Fastâ†’Moderateâ†’Slowâ†’Fine)
- `completion_status` (string): "success", "error", "cancelled", "timeout"
- `timestamp` (int): Unix timestamp (seconds since epoch)

### 2. System Events

**Topic:** `factory/pump/events`

**Published:** On significant system events (startup, shutdown, safety checks, errors)

**Payload:**
```json
{
  "device_id": "bdo_pump_01",
  "event": "safety_check_complete",
  "details": "All 4 safety checks passed",
  "timestamp": 1699294832
}
```

**Event Types:**
- `system_boot` - Controller started up
- `wifi_connected` - WiFi connection established
- `mqtt_connected` - MQTT broker connection established
- `safety_check_start` - Safety checklist initiated
- `safety_check_complete` - All safety checks passed
- `safety_check_failed` - Safety check timeout or cancellation
- `fill_start` - Fill operation started
- `fill_complete` - Fill operation completed (success)
- `fill_cancelled` - Fill cancelled by operator
- `fill_error` - Fill error occurred
- `scale_error` - Scale communication error
- `pressure_fault` - ITV2030 pressure feedback fault
- `system_idle` - System returned to idle state

**Payload Fields:**
- `device_id` (string): Unique identifier
- `event` (string): Event type
- `details` (string): Human-readable description
- `timestamp` (int): Unix timestamp

### 3. Real-Time Status Updates

**Topic:** `factory/pump/status`

**Published:** Every 5 seconds during operation, every 30 seconds when idle

**Payload:**
```json
{
  "device_id": "bdo_pump_01",
  "state": "FILLING",
  "current_weight_lbs": 125.4,
  "target_weight_lbs": 200.0,
  "progress_pct": 62.7,
  "current_pressure_pct": 40.0,
  "active_zone": "SLOW",
  "fill_elapsed_ms": 102340,
  "fills_today": 12,
  "total_lbs_today": 2400.5,
  "uptime_seconds": 86420,
  "timestamp": 1699294832
}
```

**States:**
- `IDLE` - Standby, ready for next fill
- `SAFETY_CHECK` - Running 4-stage safety checklist
- `FILLING` - Actively dispensing
- `COMPLETED` - Fill just completed (brief state)
- `ERROR` - Fault condition

**Payload Fields:**
- `device_id` (string): Unique identifier
- `state` (string): Current operating state
- `current_weight_lbs` (float): Current scale reading
- `target_weight_lbs` (float): Target for current/next fill
- `progress_pct` (float): Fill progress percentage (0-100)
- `current_pressure_pct` (float): Current ITV2030 pressure setpoint (0-100)
- `active_zone` (string): "FAST", "MODERATE", "SLOW", "FINE", or "IDLE"
- `fill_elapsed_ms` (int): Time since fill started (0 if idle)
- `fills_today` (int): Number of fills completed today (resets at midnight)
- `total_lbs_today` (float): Total pounds dispensed today
- `uptime_seconds` (int): Time since last boot
- `timestamp` (int): Unix timestamp

### 4. Daily Summary (Optional - Generated by Controller)

**Topic:** `factory/pump/summary`

**Published:** Once daily at midnight, or on-demand via WebUI

**Payload:**
```json
{
  "device_id": "bdo_pump_01",
  "date": "2025-11-06",
  "total_fills": 47,
  "total_lbs_dispensed": 9425.3,
  "avg_fill_lbs": 200.5,
  "avg_error_lbs": 0.15,
  "avg_fill_time_ms": 176800,
  "max_error_lbs": 0.8,
  "min_error_lbs": -0.3,
  "errors_count": 2,
  "cancellations_count": 1,
  "timestamp": 1699315200
}
```

---

## TimescaleDB Schema

### Table 1: pump_fills

```sql
CREATE TABLE pump_fills (
    time TIMESTAMPTZ NOT NULL,
    device_id TEXT NOT NULL,
    target_lbs DOUBLE PRECISION,
    actual_lbs DOUBLE PRECISION,
    error_lbs DOUBLE PRECISION,
    fill_time_ms BIGINT,
    fill_number INTEGER,
    pressure_avg_pct DOUBLE PRECISION,
    zone_transitions INTEGER,
    completion_status TEXT
);

SELECT create_hypertable('pump_fills', 'time');

CREATE INDEX idx_pump_fills_device_time ON pump_fills (device_id, time DESC);
CREATE INDEX idx_pump_fills_status ON pump_fills (completion_status, time DESC);
```

### Table 2: pump_events

```sql
CREATE TABLE pump_events (
    time TIMESTAMPTZ NOT NULL,
    device_id TEXT NOT NULL,
    event TEXT NOT NULL,
    details TEXT
);

SELECT create_hypertable('pump_events', 'time');

CREATE INDEX idx_pump_events_device_time ON pump_events (device_id, time DESC);
CREATE INDEX idx_pump_events_type ON pump_events (event, time DESC);
```

### Table 3: pump_status

```sql
CREATE TABLE pump_status (
    time TIMESTAMPTZ NOT NULL,
    device_id TEXT NOT NULL,
    state TEXT NOT NULL,
    current_weight_lbs DOUBLE PRECISION,
    target_weight_lbs DOUBLE PRECISION,
    progress_pct DOUBLE PRECISION,
    current_pressure_pct DOUBLE PRECISION,
    active_zone TEXT,
    fill_elapsed_ms BIGINT,
    fills_today INTEGER,
    total_lbs_today DOUBLE PRECISION,
    uptime_seconds BIGINT
);

SELECT create_hypertable('pump_status', 'time');

CREATE INDEX idx_pump_status_device_time ON pump_status (device_id, time DESC);
CREATE INDEX idx_pump_status_state ON pump_status (state, time DESC);
```

### Continuous Aggregates

```sql
-- Hourly fill statistics
CREATE MATERIALIZED VIEW pump_fills_hourly
WITH (timescaledb.continuous) AS
SELECT
    time_bucket('1 hour', time) AS bucket,
    device_id,
    completion_status,
    COUNT(*) as fill_count,
    SUM(actual_lbs) as total_lbs,
    AVG(actual_lbs) as avg_lbs,
    AVG(error_lbs) as avg_error_lbs,
    STDDEV(error_lbs) as stddev_error_lbs,
    AVG(fill_time_ms) / 1000.0 as avg_fill_time_sec,
    MIN(actual_lbs) as min_lbs,
    MAX(actual_lbs) as max_lbs
FROM pump_fills
GROUP BY bucket, device_id, completion_status;

SELECT add_continuous_aggregate_policy('pump_fills_hourly',
    start_offset => INTERVAL '2 hours',
    end_offset => INTERVAL '1 hour',
    schedule_interval => INTERVAL '1 hour');

-- Daily fill statistics
CREATE MATERIALIZED VIEW pump_fills_daily
WITH (timescaledb.continuous) AS
SELECT
    time_bucket('1 day', time) AS bucket,
    device_id,
    COUNT(*) as fill_count,
    SUM(actual_lbs) as total_lbs_dispensed,
    AVG(actual_lbs) as avg_fill_lbs,
    AVG(error_lbs) as avg_error_lbs,
    COUNT(*) FILTER (WHERE completion_status = 'success') as successful_fills,
    COUNT(*) FILTER (WHERE completion_status = 'error') as error_fills,
    COUNT(*) FILTER (WHERE completion_status = 'cancelled') as cancelled_fills
FROM pump_fills
GROUP BY bucket, device_id;

SELECT add_continuous_aggregate_policy('pump_fills_daily',
    start_offset => INTERVAL '3 days',
    end_offset => INTERVAL '1 day',
    schedule_interval => INTERVAL '1 day');
```

---

## Telegraf Configuration

Add to your Telegraf config:

```toml
# =============================================================================
# BDO PNEUMATIC PUMP - MQTT INPUTS
# =============================================================================

# Fill completion events
[[inputs.mqtt_consumer]]
  servers = ["tcp://mosquitto:1883"]
  topics = ["factory/pump/fills"]
  qos = 1
  data_format = "json"
  json_time_key = "timestamp"
  json_time_format = "unix"
  name_override = "pump_fills"
  tag_keys = ["device_id", "completion_status"]

# System events
[[inputs.mqtt_consumer]]
  servers = ["tcp://mosquitto:1883"]
  topics = ["factory/pump/events"]
  qos = 1
  data_format = "json"
  json_time_key = "timestamp"
  json_time_format = "unix"
  name_override = "pump_events"
  tag_keys = ["device_id", "event"]

# Real-time status
[[inputs.mqtt_consumer]]
  servers = ["tcp://mosquitto:1883"]
  topics = ["factory/pump/status"]
  qos = 0
  data_format = "json"
  json_time_key = "timestamp"
  json_time_format = "unix"
  name_override = "pump_status"
  tag_keys = ["device_id", "state", "active_zone"]

# =============================================================================
# OUTPUT TO TIMESCALEDB
# =============================================================================

[[outputs.postgresql]]
  connection = "host=timescaledb port=5432 user=telegraf password=your_secure_password dbname=factory_metrics sslmode=disable"

  tables = [
    {
      measurement = "pump_fills",
      table = "pump_fills",
      tags = ["device_id", "completion_status"],
      fields = ["target_lbs", "actual_lbs", "error_lbs", "fill_time_ms", "fill_number", "pressure_avg_pct", "zone_transitions"],
      timestamp_column = "time"
    },
    {
      measurement = "pump_events",
      table = "pump_events",
      tags = ["device_id", "event"],
      fields = ["details"],
      timestamp_column = "time"
    },
    {
      measurement = "pump_status",
      table = "pump_status",
      tags = ["device_id", "state", "active_zone"],
      fields = ["current_weight_lbs", "target_weight_lbs", "progress_pct", "current_pressure_pct", "fill_elapsed_ms", "fills_today", "total_lbs_today", "uptime_seconds"],
      timestamp_column = "time"
    }
  ]
```

---

## Grafana Dashboard Queries

### Panel 1: Total Fills Today

```sql
SELECT COUNT(*) as fills_today
FROM pump_fills
WHERE time >= CURRENT_DATE
  AND time < CURRENT_DATE + INTERVAL '1 day'
  AND completion_status = 'success';
```

### Panel 2: Total Pounds Dispensed Today

```sql
SELECT SUM(actual_lbs) as total_lbs
FROM pump_fills
WHERE time >= CURRENT_DATE
  AND time < CURRENT_DATE + INTERVAL '1 day'
  AND completion_status = 'success';
```

### Panel 3: Fill Accuracy (Last 24 Hours)

```sql
SELECT
  time_bucket('1 hour', time) AS time,
  AVG(error_lbs) as avg_error,
  STDDEV(error_lbs) as error_stddev
FROM pump_fills
WHERE time >= NOW() - INTERVAL '24 hours'
  AND completion_status = 'success'
GROUP BY time_bucket('1 hour', time)
ORDER BY time;
```

### Panel 4: Fills Per Hour

```sql
SELECT
  time_bucket('1 hour', time) AS time,
  COUNT(*) as fills
FROM pump_fills
WHERE time >= $__timeFrom() AND time <= $__timeTo()
GROUP BY time_bucket('1 hour', time)
ORDER BY time;
```

### Panel 5: Current System Status

```sql
SELECT DISTINCT ON (device_id)
  state,
  progress_pct,
  current_weight_lbs,
  target_weight_lbs
FROM pump_status
ORDER BY device_id, time DESC;
```

---

## Configuration in ESP32 Firmware

```cpp
// config.h
#define MQTT_DEVICE_ID "bdo_pump_01"

// MQTT Topics
#define MQTT_TOPIC_FILLS   "factory/pump/fills"
#define MQTT_TOPIC_EVENTS  "factory/pump/events"
#define MQTT_TOPIC_STATUS  "factory/pump/status"

// Publishing intervals
#define MQTT_STATUS_INTERVAL_FILLING  5000   // 5 seconds during fill
#define MQTT_STATUS_INTERVAL_IDLE     30000  // 30 seconds when idle
```

---

## Message Frequency Estimates

**During Active Filling (200 lb, ~3 minutes):**
- Fill event: 1 message (at completion)
- Events: ~2-4 messages (safety checks, start, complete)
- Status updates: ~36 messages (every 5 seconds for 180 seconds)

**Total per fill:** ~40-45 messages

**Daily (47 fills/day):**
- Fill events: 47 messages
- System events: ~200 messages
- Status updates: ~4,000 messages (during fills) + ~2,880 messages (idle, every 30s)
- **Daily total:** ~7,127 messages/day

**Data volume:** ~100 KB/day (highly compressed in TimescaleDB)

---

## Global Tags

All measurements will include global tags from Telegraf:

```toml
[global_tags]
  facility = "main_factory"
  system = "bdo_pump"
```

This allows querying across multiple systems:
- `system = "chemical_dosing"` â†’ Peristaltic pumps
- `system = "bdo_pump"` â†’ BDO pneumatic pump

---

## Data Retention

Following existing infrastructure:

- **Raw data:** 90 days
- **Hourly aggregates:** 2 years
- **Daily aggregates:** 2 years
- **Compression:** After 7 days

---

## Future Enhancements

- ðŸ“Š Predictive maintenance alerts (fill time trending)
- ðŸ”” Real-time alerts (low accuracy, long fill times)
- ðŸ“ˆ Shift/batch tracking
- ðŸ§ª Recipe management (different target weights)
- ðŸ“¦ BDO inventory tracking
- ðŸŒ¡ï¸ Environmental data (temperature, humidity)

---

**Document Version:** 1.0
**Status:** Ready for Implementation
**Integration:** Seamless with existing factory infrastructure âœ…
