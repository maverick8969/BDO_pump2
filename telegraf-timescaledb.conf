# =============================================================================
# TELEGRAF CONFIGURATION FOR TIMESCALEDB
# Chemical Dosing System - MQTT to TimescaleDB
# =============================================================================

# Global Agent Configuration
[agent]
  interval = "10s"
  round_interval = true
  metric_batch_size = 1000
  metric_buffer_limit = 10000
  collection_jitter = "0s"
  flush_interval = "10s"
  flush_jitter = "0s"
  precision = ""
  hostname = ""
  omit_hostname = false

# =============================================================================
# GLOBAL TAGS
# =============================================================================

[global_tags]
  facility = "main_factory"
  system = "chemical_dosing"

# =============================================================================
# MQTT INPUTS
# =============================================================================

# -----------------------------------------------------------------------------
# Dosing Consumption Data
# -----------------------------------------------------------------------------
[[inputs.mqtt_consumer]]
  servers = ["tcp://mosquitto:1883"]
  topics = ["factory/dosing/consumption"]

  ## QoS (0, 1, or 2)
  qos = 0

  ## Connection timeout
  connection_timeout = "30s"

  ## Authentication (uncomment if needed)
  # username = "telegraf"
  # password = "your_mqtt_password"

  ## Data format
  data_format = "json"
  json_time_key = "timestamp"
  json_time_format = "unix"

  ## Name override (maps to table name)
  name_override = "dosing_consumption"

  ## Tag keys (these become indexed columns)
  tag_keys = ["device_id", "chemical", "recipe", "mode"]

# -----------------------------------------------------------------------------
# Batch Events
# -----------------------------------------------------------------------------
[[inputs.mqtt_consumer]]
  servers = ["tcp://mosquitto:1883"]
  topics = ["factory/batch/events"]

  qos = 0
  connection_timeout = "30s"

  data_format = "json"
  json_time_key = "timestamp"
  json_time_format = "unix"

  name_override = "batch_events"

  tag_keys = ["device_id", "event", "recipe"]

# -----------------------------------------------------------------------------
# Inventory Levels
# -----------------------------------------------------------------------------
[[inputs.mqtt_consumer]]
  servers = ["tcp://mosquitto:1883"]
  topics = ["factory/inventory/levels"]

  qos = 0
  connection_timeout = "30s"

  data_format = "json"

  name_override = "inventory_levels"

  tag_keys = ["device_id", "chemical"]

# =============================================================================
# OUTPUT TO TIMESCALEDB (PostgreSQL)
# =============================================================================

[[outputs.postgresql]]
  ## Connection string
  ## Format: "host=... port=... user=... password=... dbname=... sslmode=..."
  connection = "host=timescaledb port=5432 user=telegraf password=your_secure_password dbname=factory_metrics sslmode=disable"

  ## Create tables automatically if they don't exist
  ## Note: Tables must already exist if you want hypertables - create them manually
  create_templates = []

  ## Timeout for writes
  timeout = "5s"

  ## Table mapping
  ## Maps measurement names to database tables
  tables = [
    {
      measurement = "dosing_consumption",
      table = "dosing_consumption",
      ## Tags become TEXT columns (indexed)
      tags = ["device_id", "chemical", "recipe", "mode"],
      ## Fields become data columns (not indexed by default)
      fields = ["pump", "target_g", "actual_g", "error_g", "duration_ms"],
      ## Timestamp column
      timestamp_column = "time"
    },
    {
      measurement = "batch_events",
      table = "batch_events",
      tags = ["device_id", "event", "recipe"],
      fields = ["pumps"],
      timestamp_column = "time"
    },
    {
      measurement = "inventory_levels",
      table = "inventory_levels",
      tags = ["device_id", "chemical"],
      fields = ["remaining_g", "capacity_g", "percent_full"],
      timestamp_column = "time"
    }
  ]

  ## Tag and field templates (optional, for custom column types)
  ## Useful if you need specific PostgreSQL types
  tag_template = "{{.tag}} TEXT"
  field_template = "{{.field}} DOUBLE PRECISION"

# =============================================================================
# OPTIONAL: OUTPUT TO FILE (for debugging)
# =============================================================================
# Uncomment to write data to file for debugging

# [[outputs.file]]
#   files = ["/tmp/telegraf-debug.out"]
#   data_format = "json"
#   json_timestamp_units = "1s"

# =============================================================================
# OPTIONAL: INTERNAL MONITORING
# =============================================================================

# Monitor Telegraf itself
[[inputs.internal]]
  collect_memstats = true
